 <!DOCTYPE html>
<html>
<body>

<h3>Open Journal Systems User File Converter</h3>
<h4>This Javascript-based tool is intended to convert the XML-formatted user export generated by OJS to a tab-delimited format that excludes biographies, encoded passwords, and select other fields.</h4>
<p>Instructions: Use the "Browse..." button below to select a previously-saved OJS user XML file for which you would like tab-delimited output.  Once content is loaded, use the "Create File" button to stage the data, and then use the resulting "Download" link to save the tab-delimted text file.</p>
<p>NOTE: When accessed multiple times in the same browser session, the tool will display the last selected file name, but still requires that you "browse" to the desired file before it will attempt to parse any XML.</p>
<input type="file" id="file-input" />
<button id="create" style="display: none">Create file</button> <a download="ojs_user_info.txt" id="downloadLink" style="display: none">Download</a>
<pre id="file-content"></pre>
<script>
function readSingleFile(e) {
  var file = e.target.files[0];
  if (!file) {
    return;
  }
  var reader = new FileReader();
  reader.onload = function(e) {
    var contents = e.target.result;
    displayContents(contents);
  };
  reader.readAsText(file);
}

function displayNodeVal(targetNode) {
  if (targetNode) {
    return targetNode.firstChild.nodeValue;
  } else {
    return "";
  }
}

var createButton = document.getElementById('create');

function displayContents(contents) {
  var element = document.getElementById('file-content');
  var xmlDoc, i, userNode;
  parser = new DOMParser();
  xmlDoc = parser.parseFromString(contents,"text/xml");
  //pkpusers/users/user
  if (xmlDoc.getElementsByTagName("user").length > 0) {
    userNode = xmlDoc.getElementsByTagName("user");
    var txt = "username\tuser_group_ref\tsalutation\tfirstname\tmiddlename\tlastname\taffiliation\tcountry\torcid\temail\tphone\tmailing_address\turl\treview_interests\tdate_registered\tdate_last_email\tdate_last_login\n";
    for (i = 0; i < userNode.length ;i++) {
	  txt += displayNodeVal(userNode[i].getElementsByTagName("username")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("user_group_ref")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("salutation")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("firstname")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("middlename")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("lastname")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("affiliation")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("country")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("orcid")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("email")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("phone")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("mailing_address")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("url")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("review_interests")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("date_registered")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("date_last_email")[0]) + "\t";
	  txt += displayNodeVal(userNode[i].getElementsByTagName("date_last_login")[0]) + "\t";
	  txt += "\n";
    }
    element.textContent = txt;
    createButton.style="display: block"
  } else {
    element.textContent = "Expected OJS XML tags not found\n";
  }
}

document.getElementById('file-input').addEventListener('change', readSingleFile, false);

//download functions borrowed from http://jsfiddle.net/UselessCode/qm5AG/
var textFile = null,
  makeTextFile = function (text) {
    var data = new Blob([text], {type: 'text/plain'});

    // If we are replacing a previously generated file we need to
    // manually revoke the object URL to avoid memory leaks.
    if (textFile !== null) {
      window.URL.revokeObjectURL(textFile);
    }

    textFile = window.URL.createObjectURL(data);

    return textFile;
};

var textbox = document.getElementById('file-content');

createButton.addEventListener('click', function () {
    var link = document.getElementById('downloadLink');
    link.href = makeTextFile(textbox.textContent);
    link.style.display = 'block';
  }, false);

</script>

</body>
</html> 